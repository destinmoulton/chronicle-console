<!doctype html>
<html>
<head>
    <title>Chronicle Console - Actions</title>
    <script src="../index.js" ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

    <h3>Chronicle Console - Actions Tester</h3>
        <div id="loading">Loading Data...</div>
        <fieldset style="display:none" id="serverinfo">
            <legend>Configuration</legend>
            Server: <input type="text" id="input-server" size="60"/>
            <br/>
            App Test Name: <input type="text" id="input-app" size="60"/>
            <br/>
            <button id="button-initialize">Initialize</button>
            <button id="button-clear-storage">Clear Local Storage</button>
        </fieldset>
    <hr>
    <div style="border: 2px solid blue; padding: 10px; margin: 10px;">
        <div style="display:none" id="navbar">
            <button class="button-change-view" data-val="home">Home</button>
            <button class="button-change-view" data-val="about">About</button>
            <button class="button-change-view" data-val="pricing">Pricing</button>
            <button class="button-change-view" data-val="contact">Contact</button>
            <hr>
            <button id="button-login">Login</button>
        </div>
        <div style="display:none" id="adminbar">    
            <button id="button-logout">Logout</button>
        </div>
        <div style="display:none" id="random-button-box"></div>
    </div>
    <div id="contents" style="border:2px solid black; padding: 10px; margin: 10px;"></div>
    <script type="text/javascript">
        "use strict";
        (function($){
            const HEADERS = {
                        'Origin':'https://swapi.co',
                        "Accept":"application/json"
                    };

            const API_URL = "https://swapi.co/api/";
            let API_DATA = {
                people: [],
                planets: [],
                species: [],
                starships: [],
                vehicles: [],
            };


            //jQuery onload
            $(()=>{
                loadAPIData();
            });

            function loadAPIData(){
                const operations = Object.keys(API_DATA).map((uri, idx)=>{
                    return fetch(API_URL + uri, {headers: HEADERS})
                        .then((res)=>res.json())
                        .then((data)=>{
                            API_DATA[uri] = data.results;
                        })
                })

                Promise.all(operations).then(()=>{
                    setupFieldsAndEvents();
                });
            }

            function setupFieldsAndEvents(){
                $("#serverinfo").show();
                $("#loading").hide();

                $("#button-initialize").on('click', ()=>initializeLogging());
                $("#button-clear-storage").on('click', ()=>clearLocalStorage());
                $("#button-login").on('click', ()=>login());
                $("#button-logout").on('click', ()=>logout());
                $(".button-change-view").on('click', (evt)=>{
                    const $el = $(evt.target);
                    mockChangeView($el.data('val'));
                })

                if(localStorage.getItem("server")){
                    $("#input-server").val(localStorage.getItem("server"));
                }

                if(localStorage.getItem("app")){
                    $("#input-app").val(localStorage.getItem("app"));
                }

                generateRandomButtons();
                
            }

            function generateRandomButtons(){
                Object.keys(API_DATA).forEach((setName)=>{
                    const set = API_DATA[setName];
                    let items = [];
                    for(let i=0; i<5; i++){
                        const randomIndex = Math.floor(Math.random()*set.length);
                        items.push(set[randomIndex]);

                        // Remove this element from the possible data array
                        // avoids duplicating data
                        set.slice(randomIndex,1);
                    }

                    buildRandomButtons(setName, items);
                });
            }

            function buildRandomButtons(name, items){
                const id = `random-buttons-${name}`;
                const container = `<fieldset><legend>${name}</legend><ul id="${id}"></ul></fieldset>`
                $("#random-button-box").append(container);

                const $buttons = $("#"+id);
                for(let item of items){
                    const newEl = $(`<button>${item.name}</button>`).data("json", JSON.stringify(item)).on('click', (evt)=>{
                        console.action("click:data", JSON.parse($(evt.target).data("json")));
                    });

                    $buttons.append(newEl);
                }
            }

            function initializeLogging(){
                
                var server = document.getElementById("input-server").value;
                var app = document.getElementById("input-app").value;
                
                if( server && app){
                    localStorage.setItem("server", server);
                    localStorage.setItem("app", app);

                    var config = {
                        server: server,
                        app: app,
                        toConsole: true
                    }
                    ChronicleConsole.init(config);

                    console.log("test:initialized");

                    // Show the navbar
                    $("#navbar").show();
                    $("#random-button-box").show();
                }
            }

            function clearLocalStorage(){
                localStorage.removeItem("server");
                localStorage.removeItem("app");
            }

            function mockChangeView(viewName){
                console.action("user:browse", viewName);
            }

            function login(){
                console.action("user:login", API_DATA.people[0]);
                $("#button-login").prop("disabled", true);
                $("#adminbar").show();
            }

            function logout(){
                console.action("user:logout");
                $("#button-login").prop("disabled", false);
                $("#adminbar").hide();
            }
        })(jQuery);

    </script>
</body>
</html>